<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Excel Data Validator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #E0E0E0; /* A soft white for better readability on dark backgrounds */
        }

        .bg-gradient {
            background-color: #4158D0;
            background-image: linear-gradient(43deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
            min-height: 100vh;
        }

        .table-container {
            max-height: 400px; /* Or adjust as needed */
            overflow-y: auto;
        }

        /* The "glassmorphism" effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="bg-gradient">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-white">AI Excel Data Validator Pro</h1>
            <p class="text-white/80 mt-3 text-lg">Advanced validation with intelligent data analysis and comprehensive reporting.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-12 max-w-4xl mx-auto">
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-2xl font-bold text-white">15+</h3>
                <p class="text-white/70">Validation Types</p>
            </div>
            <div class="glass-card rounded-xl p-6">
                <h3 class="text-2xl font-bold text-white">100%</h3>
                <p class="text-white/70">Local & Secure</p>
            </div>
            <div class="glass-card rounded-xl p-6">
                <svg class="mx-auto h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <p class="text-white/70 mt-2">Lightning Fast</p>
            </div>
        </div>


        <main>
            <div id="upload-container" class="glass-card p-8 rounded-xl shadow-2xl text-center max-w-2xl mx-auto">
                <svg class="mx-auto h-16 w-16 text-white/70" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <h3 class="mt-4 text-xl font-medium text-white">Upload a file</h3>
                <p class="mt-2 text-base text-white/70">Drag and drop or click to upload your Excel file (.xlsx, .xls).</p>
                <div class="mt-6">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                    <button type="button" onclick="document.getElementById('file-input').click()" class="inline-flex items-center px-6 py-3 border border-transparent shadow-lg text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transform hover:scale-105 transition-transform duration-300">
                        + Select File
                    </button>
                </div>
            </div>

            <div id="loader" class="hidden text-center my-8">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-white text-lg">Processing your file...</p>
            </div>

            <div id="content-area" class="hidden mt-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-1 glass-card p-6 rounded-xl text-gray-800">
                        <h2 class="text-xl font-bold mb-4">File Details & Actions</h2>
                        <p class="mb-4 text-sm"><strong>File:</strong> <span id="file-name" class="font-semibold"></span></p>

                        <div id="sheet-buttons" class="mb-6 space-y-2">
                            <h3 class="text-lg font-semibold mb-2">Sheets</h3>
                        </div>

                        <div class="space-y-4">
                             <h4 class="font-semibold pt-2 mb-2 text-gray-600">Summary Validations</h4>
                             <div class="space-y-2">
                                 <button id="validate-wo-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                                     Summary check for WO
                                 </button>
                                 <button id="validate-pre-audit-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                                     Summary check for Pre-Audit
                                 </button>
                                 <button id="validate-post-audit-btn" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                                     Summary check for Post-Audit
                                 </button>
                                 <button id="validate-cwi-btn" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                                     Summary check for CWI
                                 </button>
                             </div>
                            
                            <h4 class="font-semibold pt-4 mb-0 text-gray-600">Calculations and Formula Checks</h4>
                            <div class="space-y-2">
                                <button id="qty-check-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check CWI Qty = Post Audit Qty
                                </button>
                                <button id="savings-excess-check-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check for Savings and Excess Logic
                                </button>
                                <button id="total-check-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check for Total = Savings + Excess
                                </button>
                                <button id="find-false-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check for Savings + Excess = CWI - WO
                                </button>
                                <button id="post-audit-wo-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check Post audit qty - WO (qty) formula
                                </button>
                                <button id="post-audit-wo-amt-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check Post audit Amt- WO (amt) formula
                                </button>
                                <button id="pre-audit-cwi-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check CWI qty - Pre Audit (qty) formula
                                </button>
                                <button id="pre-audit-cwi-amt-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check CWI amt - Pre Audit (amt) formula
                                </button>
                                <button id="variance-cwi-wo-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check CWI vs WO Qty Variance
                                </button>
                            </div>

                            <h4 class="font-semibold pt-4 mb-0 text-gray-600">Remark check</h4>
                            <div class="space-y-2">
                                <button id="work-not-in-wo-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Remarks for "Not in WO"
                                </button>
                                <button id="exceeded-wo-qty-btn" class="w-full bg-yellow-500 text-black font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Remarks for "In WO but Exceeded"
                                </button>
                            </div>
                            
                            <h4 class="font-semibold pt-4 mb-0 text-gray-600">Variance check</h4>
                            <div class="space-y-2">
                                <button id="variance-threshold-btn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check for (Nos) based items exceeding 10%
                                </button>
                                <button id="running-items-variance-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Check for (R.ft/R.mt) based items exceeding 10%
                                </button>
                            </div>
                            
                            <hr class="my-4 border-gray-400">
                            
                            <h4 class="font-semibold pt-2 mb-2 text-gray-600">Reporting</h4>
                            <button id="download-report-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                                Download Error Report (0)
                            </button>

                            <hr class="my-4 border-gray-400">
                                <button id="debug-headers-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    Debug Headers
                                </button>
                        </div>

                        <div id="validation-results" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-2">Validation Results</h3>
                            <div id="results-container" class="space-y-3"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 glass-card p-6 rounded-xl text-gray-800">
                        <h2 id="sheet-title" class="text-xl font-bold mb-4">Select a sheet to view its data</h2>
                        <div id="data-table-container" class="table-container border rounded-lg bg-white/80">
                            <table id="data-table" class="min-w-full divide-y divide-gray-300">
                            </table>
                        </div>
                        <p id="no-data" class="text-center text-gray-500 py-10">No data to display.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- State Management ---
        let workbook = null;
        let sheetNames = [];
        let summaryData = [];
        let extractedDataGroups = [];
        let errorReportData = [];

        // --- Error Type Constants ---
        const errorTypes = {
            WO_SUMMARY_MISMATCH: 'Summary vs Extracted (WO) Total Mismatch',
            PRE_AUDIT_SUMMARY_MISMATCH: 'Summary vs Extracted (Pre-Audit) Total Mismatch',
            POST_AUDIT_SUMMARY_MISMATCH: 'Summary vs Extracted (Post-Audit) Total Mismatch',
            CWI_SUMMARY_MISMATCH: 'Summary vs Extracted (CWI) Total Mismatch',
            QTY_MISMATCH: 'CWI vs Post-Audit Quantity Mismatch',
            TOTAL_CALC: "'Total' Column Calculation Error",
            SAVINGS_EXCESS_LOGIC: "'Savings'/'Excess' Logic Error",
            FALSE_CHECK: "Failed 'True/False' Check",
            POST_AUDIT_WO_VARIANCE: "'Variance Post Audit VS WO (Qty)' Calculation Error",
            PRE_AUDIT_CWI_VARIANCE: "'Variance Pre Audit VS CWI (Qty)' Calculation Error",
            POST_AUDIT_WO_VARIANCE_AMT: "'Variance Post Audit VS WO (Amt)' Calculation Error",
            PRE_AUDIT_CWI_VARIANCE_AMT: "'Variance Pre Audit VS CWI (Amt)' Calculation Error",
            CWI_WO_VARIANCE: "'Variance (CWI vs WO)' Calculation Error",
            WORK_NOT_IN_WO: 'Work Executed Not In WO (Missing Remark)',
            EXCEEDED_WO_QTY: 'Exceeded WO Quantity (Missing Remark)',
            POSITIVE_VARIANCE_NOS: '>10% Positive Variance (Unit: Nos)',
            POSITIVE_VARIANCE_RUNNING: '>10% Positive Variance (Unit: R.ft/R.mt)',
        };

        // --- DOM Element References ---
        const fileInput = document.getElementById('file-input');
        const uploadContainer = document.getElementById('upload-container');
        const contentArea = document.getElementById('content-area');
        const loader = document.getElementById('loader');
        const fileNameEl = document.getElementById('file-name');
        const sheetButtonsContainer = document.getElementById('sheet-buttons');
        const validateWoBtn = document.getElementById('validate-wo-btn');
        const validatePreAuditBtn = document.getElementById('validate-pre-audit-btn');
        const validatePostAuditBtn = document.getElementById('validate-post-audit-btn');
        const validateCwiBtn = document.getElementById('validate-cwi-btn');
        const qtyCheckBtn = document.getElementById('qty-check-btn');
        const totalCheckBtn = document.getElementById('total-check-btn');
        const savingsExcessCheckBtn = document.getElementById('savings-excess-check-btn');
        const findFalseBtn = document.getElementById('find-false-btn');
        const postAuditWoBtn = document.getElementById('post-audit-wo-btn');
        const preAuditCwiBtn = document.getElementById('pre-audit-cwi-btn');
        const varianceCwiWoBtn = document.getElementById('variance-cwi-wo-btn');
        const workNotInWoBtn = document.getElementById('work-not-in-wo-btn');
        const exceededWoQtyBtn = document.getElementById('exceeded-wo-qty-btn');
        const varianceThresholdBtn = document.getElementById('variance-threshold-btn');
        const runningItemsVarianceBtn = document.getElementById('running-items-variance-btn');
        const debugHeadersBtn = document.getElementById('debug-headers-btn');
        const sheetTitleEl = document.getElementById('sheet-title');
        const dataTableContainer = document.getElementById('data-table-container');
        const dataTableEl = document.getElementById('data-table');
        const noDataEl = document.getElementById('no-data');
        const validationResultsEl = document.getElementById('validation-results');
        const resultsContainer = document.getElementById('results-container');
        const downloadReportBtn = document.getElementById('download-report-btn');
        // --- NEW Button References ---
        const postAuditWoAmtBtn = document.getElementById('post-audit-wo-amt-btn');
        const preAuditCwiAmtBtn = document.getElementById('pre-audit-cwi-amt-btn');


        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFile);
        validateWoBtn.addEventListener('click', runWoValidation);
        validatePreAuditBtn.addEventListener('click', runPreAuditValidation);
        validatePostAuditBtn.addEventListener('click', runPostAuditValidation);
        validateCwiBtn.addEventListener('click', runCwiValidation);
        qtyCheckBtn.addEventListener('click', runQuantityCheck);
        totalCheckBtn.addEventListener('click', runTotalCheck);
        savingsExcessCheckBtn.addEventListener('click', runSavingsExcessCheck);
        findFalseBtn.addEventListener('click', runFalseCheckValidation);
        postAuditWoBtn.addEventListener('click', runPostAuditWoCheck);
        preAuditCwiBtn.addEventListener('click', runPreAuditCwiCheck);
        varianceCwiWoBtn.addEventListener('click', runVarianceCwiWoCheck);
        workNotInWoBtn.addEventListener('click', runWorkNotInWoCheck);
        exceededWoQtyBtn.addEventListener('click', runExceededWoQtyCheck);
        varianceThresholdBtn.addEventListener('click', runVarianceThresholdCheck);
        runningItemsVarianceBtn.addEventListener('click', runRunningItemsVarianceCheck);
        debugHeadersBtn.addEventListener('click', debugHeaders);
        downloadReportBtn.addEventListener('click', generateErrorReport);
        // --- NEW Event Listeners ---
        postAuditWoAmtBtn.addEventListener('click', runPostAuditWoAmtCheck);
        preAuditCwiAmtBtn.addEventListener('click', runPreAuditCwiAmtCheck);

        // --- Core UI Functions ---
        async function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            uploadContainer.classList.add('hidden');
            loader.classList.remove('hidden');
            contentArea.classList.add('hidden');
            validationResultsEl.classList.add('hidden');
            fileNameEl.textContent = file.name;

            try {
                const data = await file.arrayBuffer();
                workbook = XLSX.read(data);
                sheetNames = workbook.SheetNames;
                
                errorReportData = [];
                updateReportButtonStatus();

                displaySheetButtons();
                contentArea.classList.remove('hidden');

                if (sheetNames.length > 0) {
                    displaySheetData(sheetNames[0]);
                    const firstButton = sheetButtonsContainer.querySelector('button');
                    if (firstButton) firstButton.classList.add('bg-indigo-100', 'border-indigo-400', 'font-semibold');
                }
            } catch (error) {
                console.error("Error processing file:", error);
                alert("There was an error processing your file. Please try again.");
                resetUI();
            } finally {
                loader.classList.add('hidden');
            }
        }

        function resetUI() {
            uploadContainer.classList.remove('hidden');
            contentArea.classList.add('hidden');
            loader.classList.add('hidden');
            fileInput.value = '';
            workbook = null;
            sheetNames = [];
            summaryData = [];
            extractedDataGroups = [];
            errorReportData = [];
            updateReportButtonStatus();
        }

        function displaySheetButtons() {
            sheetButtonsContainer.innerHTML = `<h3 class="text-lg font-semibold mb-2">Sheets</h3>`;
            sheetNames.forEach(name => {
                const button = document.createElement('button');
                button.textContent = name;
                button.className = 'w-full text-left px-3 py-2 border rounded-md text-sm hover:bg-indigo-50 hover:border-indigo-300 focus:outline-none focus:bg-indigo-100 focus:border-indigo-400 transition-colors border-gray-300';
                button.onclick = (e) => {
                    sheetButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('bg-indigo-100', 'border-indigo-400', 'font-semibold'));
                    e.target.classList.add('bg-indigo-100', 'border-indigo-400', 'font-semibold');
                    displaySheetData(name);
                };
                sheetButtonsContainer.appendChild(button);
            });
            checkValidationReadiness();
        }

        function checkValidationReadiness() {
            const sheetNamesLower = sheetNames.map(s => s.toLowerCase().trim());
            const hasSummary = sheetNamesLower.includes('summary sheet');
            const hasExtracted = sheetNamesLower.includes('extracted data');

            const isSummaryReady = hasSummary && hasExtracted;
            validateWoBtn.disabled = !isSummaryReady;
            validatePreAuditBtn.disabled = !isSummaryReady;
            validatePostAuditBtn.disabled = !isSummaryReady;
            validateCwiBtn.disabled = !isSummaryReady;
            
            workNotInWoBtn.disabled = !hasExtracted;
            exceededWoQtyBtn.disabled = !hasExtracted;
            varianceThresholdBtn.disabled = !hasExtracted;
            runningItemsVarianceBtn.disabled = !hasExtracted;
            qtyCheckBtn.disabled = !hasExtracted;
            totalCheckBtn.disabled = !hasExtracted;
            savingsExcessCheckBtn.disabled = !hasExtracted;
            findFalseBtn.disabled = !hasExtracted;
            postAuditWoBtn.disabled = !hasExtracted;
            preAuditCwiBtn.disabled = !hasExtracted;
            varianceCwiWoBtn.disabled = !hasExtracted;
            debugHeadersBtn.disabled = !hasExtracted;
            postAuditWoAmtBtn.disabled = !hasExtracted; // NEW
            preAuditCwiAmtBtn.disabled = !hasExtracted; // NEW


            const summaryTitle = isSummaryReady ? "" : "File must contain a 'Summary Sheet' and an 'Extracted Data' sheet.";
            validateWoBtn.title = isSummaryReady ? "Compare WO totals between 'Summary Sheet' and 'Extracted Data' sheet" : summaryTitle;
            validatePreAuditBtn.title = isSummaryReady ? "Compare Pre-Audit totals between 'Summary Sheet' and 'Extracted Data' sheet" : summaryTitle;
            validatePostAuditBtn.title = isSummaryReady ? "Compare Post-Audit totals between 'Summary Sheet' and 'Extracted Data' sheet" : summaryTitle;
            validateCwiBtn.title = isSummaryReady ? "Compare CWI totals between 'Summary Sheet' and 'Extracted Data' sheet" : summaryTitle;

            const extractedSheetTitle = "File must contain an 'Extracted Data' sheet.";
            workNotInWoBtn.title = hasExtracted ? "Finds executed work not in the WO that is missing a remark" : extractedSheetTitle;
            exceededWoQtyBtn.title = hasExtracted ? "Finds work where the executed quantity is greater than the WO quantity and is missing a remark" : extractedSheetTitle;
            varianceThresholdBtn.title = hasExtracted ? "Finds items (Unit: Nos) where the quantity variance between Post-Audit and Work Order is positive and exceeds 10%" : extractedSheetTitle;
            runningItemsVarianceBtn.title = hasExtracted ? "Finds R.ft/R.mt items where the quantity variance is positive and exceeds 10%" : extractedSheetTitle;
            qtyCheckBtn.title = hasExtracted ? "Compare CWI vs Post-Audit quantities" : extractedSheetTitle;
            totalCheckBtn.title = hasExtracted ? "Check 'Total' = 'Savings' + 'Excess'" : extractedSheetTitle;
            savingsExcessCheckBtn.title = hasExtracted ? "Validate 'Savings' and 'Excess' calculation logic" : extractedSheetTitle;
            findFalseBtn.title = hasExtracted ? "Find all rows where the 'True/False' check has failed" : extractedSheetTitle;
            postAuditWoBtn.title = hasExtracted ? "Validate 'Variance Post Audit VS WO (Qty)' column" : extractedSheetTitle;
            preAuditCwiBtn.title = hasExtracted ? "Validate 'Variance Pre Audit VS CWI (Qty)' column" : extractedSheetTitle;
            varianceCwiWoBtn.title = hasExtracted ? "Validate 'Variance (CWI vs WO)' column calculation" : extractedSheetTitle;
            debugHeadersBtn.title = hasExtracted ? "Show the exact headers the tool reads from your sheet" : extractedSheetTitle;
            postAuditWoAmtBtn.title = hasExtracted ? "Validate 'Variance Post Audit VS WO (Amt)' column" : extractedSheetTitle; // NEW
            preAuditCwiAmtBtn.title = hasExtracted ? "Validate 'Variance Pre Audit VS CWI (Amt)' column" : extractedSheetTitle; // NEW
        }

        function displaySheetData(sheetName) {
            sheetTitleEl.textContent = `Sheet: ${sheetName}`;
            const sheet = workbook.Sheets[sheetName];
            if (!sheet) return;

            const jsonData = XLSX.utils.sheet_to_json(sheet, {
                header: 1,
                defval: ''
            });
            dataTableEl.innerHTML = '';

            if (jsonData.length === 0) {
                dataTableContainer.classList.add('hidden');
                noDataEl.classList.remove('hidden');
                return;
            }

            dataTableContainer.classList.remove('hidden');
            noDataEl.classList.add('hidden');

            const thead = document.createElement('thead');
            thead.className = 'bg-gray-200 sticky top-0';
            const headerRow = document.createElement('tr');
            (jsonData[0] || []).forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.className = 'px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            dataTableEl.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            jsonData.slice(1).forEach(rowData => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            dataTableEl.appendChild(tbody);
        }
        
        // --- Reporting Functions ---
        function updateReportButtonStatus() {
            const errorCount = errorReportData.length;
            downloadReportBtn.disabled = errorCount === 0;
            downloadReportBtn.textContent = `Download Error Report (${errorCount})`;
            downloadReportBtn.title = errorCount > 0
                ? `Click to download an Excel report with ${errorCount} detected issue(s).`
                : "No errors detected to report. Run some checks first.";
        }

        function updateErrorReport(newErrors, errorType, formatter) {
            errorReportData = errorReportData.filter(error => error.type !== errorType);

            if (newErrors && newErrors.length > 0) {
                const formattedErrors = newErrors.map(error => formatter(error, errorType));
                errorReportData.push(...formattedErrors);
            }
            updateReportButtonStatus();
        }

        function generateErrorReport() {
            if (errorReportData.length === 0) {
                alert("No errors have been detected to generate a report.");
                return;
            }

            const dataForSheet = errorReportData.map((error, index) => ({
                'Sr.No': index + 1,
                'Error Observed In Particulars': error.particulars,
                'Type of Error': error.type,
                'Correction Required': error.correction
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataForSheet);
            const colWidths = [ { wch: 8 }, { wch: 70 }, { wch: 45 }, { wch: 70 } ];
            worksheet['!cols'] = colWidths;
            const headerStyle = { fill: { fgColor: { rgb: "FFDDDDDD" } }, font: { bold: true } };
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const headerRowIndex = range.s.r;
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({ r: headerRowIndex, c: C });
                if (worksheet[cellAddress]) worksheet[cellAddress].s = headerStyle;
            }
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, worksheet, 'Error Report');
            XLSX.writeFile(newWorkbook, 'Validation_Error_Report.xlsx');
        }


        document.addEventListener('DOMContentLoaded', () => {
            updateReportButtonStatus();
        });

        // --- Helper Functions ---
        function findKey(row, potentialKeys) {
            if (!row) return undefined;
            const rowKeys = Object.keys(row);
            const normalizeHeader = (str) => {
                if (typeof str !== 'string') return '';
                return str.toLowerCase().replace(/[^a-z0-9]/g, '');
            };
            for (const pKey of potentialKeys) {
                const normalizedPKey = normalizeHeader(pKey);
                const foundKey = rowKeys.find(rKey => normalizeHeader(rKey) === normalizedPKey);
                if (foundKey) return foundKey;
            }
            return undefined;
        }

        function normalizeString(str) {
            if (typeof str !== 'string' || !str) return '';
            return str.toLowerCase().replace(/^[ivxlcdm]+\.\s*/, '').replace(/&/g, 'and').replace(/[^a-z0-9]/g, '');
        }

        function extractRomanNumeral(text) {
            if (typeof text !== 'string') return null;
            const romanPattern = /^([IVXLCDM]+)(?=[^A-Z]|$)/;
            const match = text.trim().match(romanPattern);
            if (match) {
                const romanCandidate = match[1];
                if (/^(I{1,3}|IV|V|VI{1,3}|IX|X{1,3}|XL|L|LX{1,3}|XC|C{1,3}|CD|D|DC{1,3}|CM|M{1,3})$/.test(romanCandidate)) {
                    return romanCandidate;
                }
            }
            return null;
        }

        function findPrioritizedSheet(sheetNameArray) {
            if (!workbook) return null;
            for (const sheetName of sheetNameArray) {
                const lowerCaseSheetName = sheetName.toLowerCase().trim();
                const actualSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === lowerCaseSheetName);
                if (actualSheetName) {
                    return { sheet: workbook.Sheets[actualSheetName], name: actualSheetName };
                }
            }
            return null;
        }

        function findSheet(sheetName) {
            if (!workbook) return null;
            const lowerCaseSheetName = sheetName.toLowerCase().trim();
            const actualSheetName = workbook.SheetNames.find(name => name.toLowerCase().trim() === lowerCaseSheetName);
            return actualSheetName ? workbook.Sheets[actualSheetName] : null;
        }

        function checkRequiredColumns(headers, columnConfig) {
            const missing = [];
            const foundKeys = {};
            const headerObject = headers.reduce((obj, h) => ({ ...obj, [h]: '' }), {});
            for (const config of columnConfig) {
                const { keyName, potentialNames } = config;
                const foundKey = findKey(headerObject, potentialNames);
                if (foundKey) {
                    foundKeys[keyName] = foundKey;
                } else {
                    missing.push(`'${potentialNames.join("' or '")}'`);
                }
            }
            if (missing.length > 0) {
                alert("Cannot run validation. The 'Extracted Data' sheet is missing required columns:\n\n" + missing.join('\n'));
                return null;
            }
            return foundKeys;
        }

        // --- CORE VALIDATION LOGIC ---
        function runGenericValidation(columnConfig, processRow) {
            validationResultsEl.classList.add('hidden');
            const extractedSheet = findSheet('Extracted Data');
            if (!extractedSheet) { alert("'Extracted Data' sheet not found."); return null; }
            const sheetDataAsArray = XLSX.utils.sheet_to_json(extractedSheet, { header: 1, defval: '' });
            if (sheetDataAsArray.length < 1) { alert("'Extracted Data' sheet is empty or has no header row."); return null; }
            const headers = sheetDataAsArray[0];
            const keys = checkRequiredColumns(headers, columnConfig.keys);
            if (!keys) return null;
            const jsonData = XLSX.utils.sheet_to_json(extractedSheet);
            const mismatches = [];
            jsonData.forEach(row => {
                const result = processRow(row, keys);
                if (result) mismatches.push(result);
            });
            columnConfig.displayResults(mismatches, columnConfig);
        }

        // --- MASTER VALIDATION FUNCTION ---
        function runMasterValidation(config) {
            updateErrorReport([], config.errorType, () => {});
            try {
                const summarySheetInfo = parseSummarySheet(config);
                const extractedGroups = parseExtractedDataSheet(config);
                performComparison(summarySheetInfo, extractedGroups, config);
            } catch (e) {
                console.error("Validation Error:", e);
                alert(`An error occurred during validation: ${e.message}`);
            }
        }

        function runWoValidation() {
            runMasterValidation({
                summaryAmountKeys: ['As Per WO Amount (Rs)', 'Amount as per WO'],
                extractedAmountKey: 'As per WO (Amt)',
                errorType: errorTypes.WO_SUMMARY_MISMATCH
            });
        }

        function runPreAuditValidation() {
            runMasterValidation({
                summaryAmountKeys: ['As Per Pre Audit Amount (Rs)'],
                extractedAmountKey: 'As per Pre Audit (Amt)',
                errorType: errorTypes.PRE_AUDIT_SUMMARY_MISMATCH
            });
        }

        function runPostAuditValidation() {
            runMasterValidation({
                summaryAmountKeys: ['As Per Post Audit Amount (Rs)'],
                extractedAmountKey: 'As per Post Audit (Amt)',
                errorType: errorTypes.POST_AUDIT_SUMMARY_MISMATCH
            });
        }

        function runCwiValidation() {
            runMasterValidation({
                summaryAmountKeys: ['As Per CWI Amount (Rs)', 'Amount as per CWI'],
                extractedAmountKey: 'As per CWI (Amt)',
                errorType: errorTypes.CWI_SUMMARY_MISMATCH
            });
        }
        
        function parseSummarySheet(config) {
            const summarySheetResult = findPrioritizedSheet(['Summary Sheet']);
            if (!summarySheetResult) throw new Error("A valid sheet named 'Summary Sheet' could not be found.");
            
            const summarySheet = summarySheetResult.sheet;
            const jsonData = XLSX.utils.sheet_to_json(summarySheet);
            summaryData = [];
            const uniqueItems = new Set();
            
            jsonData.forEach(row => {
                const srNoKey = findKey(row, ['Sr.No', 'Sr. No']);
                const itemKey = findKey(row, ['Item', 'Particulars']);
                const amountKey = findKey(row, config.summaryAmountKeys);
                
                if (itemKey && amountKey) {
                    const item = row[itemKey];
                    const amount = row[amountKey];
                    if (item && typeof item === 'string' && item.trim() !== '' && typeof amount === 'number') {
                        const normalizedItem = normalizeString(item);
                        if (normalizedItem && !uniqueItems.has(normalizedItem)) {
                            let romanNumeral = srNoKey && row[srNoKey] ? extractRomanNumeral(row[srNoKey].toString()) : null;
                            summaryData.push({ originalName: item.trim(), normalizedName: normalizedItem, romanNumeral: romanNumeral, amount: amount });
                            uniqueItems.add(normalizedItem);
                        }
                    }
                }
            });
            if (summaryData.length === 0) throw new Error(`Could not parse data from '${summarySheetResult.name}'. Check for valid 'Item' and '${config.summaryAmountKeys.join('/')}' columns.`);
            return { usedSheetName: summarySheetResult.name };
        }

        function parseExtractedDataSheet(config) {
            const extractedSheet = findSheet('Extracted Data');
            if (!extractedSheet) throw new Error("'Extracted Data' sheet not found.");
            
            const jsonData = XLSX.utils.sheet_to_json(extractedSheet);
            const localExtractedDataGroups = [];
            let currentGroup = null;
            const romanHeaderPattern = /^(I{1,3}|IV|V|VI{1,3}|IX|X{1,3}|XL|L|LX{1,3}|XC|C{1,3}|CD|D|DC{1,3}|CM|M{1,3})$/;
            
            jsonData.forEach((row) => {
                const uCodeKey = findKey(row, ['U.code', 'U Code']);
                const particularsKey = findKey(row, ['Particulars', 'Item']);
                const amountKey = findKey(row, [config.extractedAmountKey]);
                
                const uCodeValue = uCodeKey ? (row[uCodeKey] || '').toString().trim() : '';
                const amountValue = (amountKey && typeof row[amountKey] === 'number') ? row[amountKey] : 0;
                
                if (romanHeaderPattern.test(uCodeValue)) {
                    if (currentGroup) localExtractedDataGroups.push(currentGroup);
                    let title = particularsKey ? (row[particularsKey] || '').toString().trim() : `Section ${uCodeValue}`;
                    currentGroup = { title: title, romanNumeral: uCodeValue, total: amountValue, itemCount: amountValue > 0 ? 1 : 0, uCodeExample: uCodeValue };
                } else if (currentGroup && amountValue > 0) {
                    currentGroup.total += amountValue;
                    currentGroup.itemCount++;
                }
            });
            if (currentGroup) localExtractedDataGroups.push(currentGroup);
            if (localExtractedDataGroups.length === 0) throw new Error("Could not parse 'Extracted Data' sheet groupings. Check for Roman numerals in the U.Code column.");
            return localExtractedDataGroups;
        }

        function performComparison(summarySheetInfo, extractedGroups, config) {
            resultsContainer.innerHTML = '';
            validationResultsEl.classList.remove('hidden');
            let hasErrors = false;
            let perfectMatches = 0;
            const mismatchesForReport = [];

            extractedGroups.forEach(group => {
                let summaryInfo = group.romanNumeral ? summaryData.find(item => item.romanNumeral === group.romanNumeral) : null;
                if (!summaryInfo) {
                    const normalizedGroupTitle = normalizeString(group.title);
                    summaryInfo = summaryData.find(item => item.normalizedName === normalizedGroupTitle);
                }
                const summaryTotal = summaryInfo ? summaryInfo.amount : undefined;
                const extractedTotal = group.total;
                const resultCard = document.createElement('div');
                let statusHtml;

                if (summaryTotal !== undefined && Math.abs(summaryTotal - extractedTotal) < 0.01) {
                    resultCard.className = 'p-4 rounded-lg border bg-green-50 border-green-400';
                    statusHtml = `<span class="flex items-center font-bold text-green-700"><svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Perfect Match</span>`;
                    perfectMatches++;
                } else {
                    hasErrors = true;
                    mismatchesForReport.push({ group, summaryInfo, summaryTotal, extractedTotal });
                    resultCard.className = 'p-4 rounded-lg border bg-red-50 border-red-400';
                    statusHtml = `<span class="flex items-center font-bold text-red-700"><svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Mismatch</span>`;
                }

                const expected = summaryTotal !== undefined ? `₹${summaryTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'Not Found in Summary';
                const calculated = `₹${extractedTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                const difference = summaryTotal !== undefined ? Math.abs(summaryTotal - extractedTotal) : 0;
                const diffText = difference > 0.01 ? `₹${difference.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '₹0.00';
                resultCard.innerHTML = `<div class="flex justify-between items-start mb-2"><p class="font-semibold text-gray-800">${group.romanNumeral || '•'}. ${group.title}</p><div class="text-sm">${statusHtml}</div></div><div class="text-sm grid grid-cols-1 md:grid-cols-3 gap-2 mb-2"><p>Summary ('${summarySheetInfo.usedSheetName}'): <span class="font-medium ${summaryTotal === undefined ? 'text-red-600' : ''}">${expected}</span></p><p>Extracted: <span class="font-medium">${calculated}</span></p><p>Difference: <span class="font-medium ${difference > 0.01 ? 'text-red-600' : 'text-green-600'}">${diffText}</span></p></div><div class="text-xs text-gray-600">Items processed: ${group.itemCount} | U.Code example: ${group.uCodeExample || 'N/A'}</div>`;
                resultsContainer.appendChild(resultCard);
            });
            
            const summaryMismatchFormatter = (mismatch, type) => {
                const particulars = `${mismatch.group.romanNumeral || '•'}. ${mismatch.group.title}`;
                let correction;
                if (mismatch.summaryInfo) {
                    const summaryAmount = mismatch.summaryTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    const extractedAmount = mismatch.extractedTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                    correction = `The summary sheet shows ₹${summaryAmount}, but the calculated total from 'Extracted Data' is ₹${extractedAmount}. Check the amounts and items included in this section for discrepancies.`;
                } else {
                    correction = `This item group from 'Extracted Data' (Total: ₹${mismatch.extractedTotal.toLocaleString('en-IN', { minimumFractionDigits: 2 })}) was not found in the summary sheet. Verify the item description or Sr.No (Roman Numeral) matches between the two sheets.`;
                }
                return { particulars, type, correction };
            };
            updateErrorReport(mismatchesForReport, config.errorType, summaryMismatchFormatter);

            const overallStatus = document.createElement('div');
            overallStatus.className = 'mb-4 p-4 rounded-lg text-center';
            const validationTypeMatch = config.errorType.match(/\(([^)]+)\)/);
            const validationType = validationTypeMatch ? validationTypeMatch[1] : 'Validation';

            if (hasErrors) {
                overallStatus.classList.add('bg-red-100', 'border', 'border-red-300');
                overallStatus.innerHTML = `<div class="font-bold text-red-800 text-lg">⚠ ${validationType} Validation Complete: Issues Found</div><div class="text-red-700 mt-1">${perfectMatches} of ${extractedGroups.length} groups match perfectly. Using '${summarySheetInfo.usedSheetName}' for comparison.</div>`;
                alert(`${validationType} Validation Complete: Issues found. Please review the mismatches in the results panel.`);
            } else {
                overallStatus.classList.add('bg-green-100', 'border', 'border-green-300');
                overallStatus.innerHTML = `<div class="font-bold text-green-800 text-lg">✅ ${validationType} Validation Complete: All Totals Match!</div><div class="text-green-700 mt-1">All ${extractedGroups.length} groups validated successfully using '${summarySheetInfo.usedSheetName}'.</div>`;
                alert(`${validationType} Validation Complete: All totals match perfectly!`);
            }
            resultsContainer.prepend(overallStatus);
        }

        // --- Other validation functions (unchanged) ---
        function runQuantityCheck() { 
            updateErrorReport([], errorTypes.QTY_MISMATCH, ()=>{});
            runGenericValidation({ 
                keys: [{ keyName: 'cwiQtyKey', potentialNames: ['As per CWI (Qty)'] }, { keyName: 'postAuditQtyKey', potentialNames: ['As per Post Audit (Qty)'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: displayQuantityCheckResults }, 
                (row, keys) => { 
                    const cwiQty = parseFloat(row[keys.cwiQtyKey]) || 0; const postAuditQty = parseFloat(row[keys.postAuditQtyKey]) || 0; 
                    if (Math.abs(cwiQty - postAuditQty) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', cwiQty: cwiQty, postAuditQty: postAuditQty, }; } return null; 
                }); 
        }
        function displayQuantityCheckResults(mismatches) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const qtyMismatchFormatter = (mismatch, type) => ({
                particulars: `${mismatch.uCode} - ${mismatch.particulars}`,
                type: type,
                correction: `Quantity mismatch found. CWI Qty is ${mismatch.cwiQty}, but Post-Audit Qty is ${mismatch.postAuditQty}. Please verify the measurements and entries.`
            });
            updateErrorReport(mismatches, errorTypes.QTY_MISMATCH, qtyMismatchFormatter);

            if (mismatches.length === 0) { 
                const successCard = document.createElement('div'); 
                successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All Quantities Match!</div><div class="text-green-700 mt-1">'As per CWI' and 'As per Post Audit' quantities are identical.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! All CWI and Post-Audit quantities match."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Quantity Mismatches Found</div><div class="text-red-700 mt-1">${mismatches.length} item(s) have different quantities.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${mismatches.length} quantity mismatch(es) found. See details below.`); 
                mismatches.forEach(item => { 
                    const diffCard = document.createElement('div'); 
                    diffCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    const diff = item.cwiQty - item.postAuditQty; 
                    diffCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-sm grid grid-cols-1 md:grid-cols-3 gap-2 mt-2"><p>CWI Qty: <span class="font-medium">${item.cwiQty.toLocaleString('en-IN')}</span></p><p>Post-Audit Qty: <span class="font-medium">${item.postAuditQty.toLocaleString('en-IN')}</span></p><p>Difference: <span class="font-bold text-red-700">${diff.toLocaleString('en-IN')}</span></p></div>`; 
                    resultsContainer.appendChild(diffCard); 
                }); 
            } 
        }
        function runTotalCheck() {
            updateErrorReport([], errorTypes.TOTAL_CALC, ()=>{});
            runGenericValidation({ 
                keys: [{ keyName: 'totalKey', potentialNames: ['Total'] }, { keyName: 'savingsKey', potentialNames: ['Savings', 'Saving'] }, { keyName: 'excessKey', potentialNames: ['Excess'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: displayTotalCheckResults }, 
                (row, keys) => { 
                    const sheetTotal = parseFloat(row[keys.totalKey]) || 0; const savings = parseFloat(row[keys.savingsKey]) || 0; const excess = parseFloat(row[keys.excessKey]) || 0; const calculatedTotal = savings + excess; 
                    if (Math.abs(sheetTotal - calculatedTotal) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', savings, excess, sheetTotal, calculatedTotal }; } return null; 
                }); 
        }
        function displayTotalCheckResults(mismatches) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const totalCheckFormatter = (mismatch, type) => ({
                particulars: `${mismatch.uCode} - ${mismatch.particulars}`,
                type: type,
                correction: `Calculation is incorrect. Sheet 'Total' (${mismatch.sheetTotal.toLocaleString()}) does not equal 'Savings' (${mismatch.savings.toLocaleString()}) + 'Excess' (${mismatch.excess.toLocaleString()}). The correct total should be ${mismatch.calculatedTotal.toLocaleString()}.`
            });
            updateErrorReport(mismatches, errorTypes.TOTAL_CALC, totalCheckFormatter);

            if (mismatches.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All Totals Match!</div><div class="text-green-700 mt-1">All 'Total' values correctly equal 'Savings' + 'Excess'.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! All 'Total' column values are correct."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Total Calculation Mismatches</div><div class="text-red-700 mt-1">${mismatches.length} item(s) have an incorrect 'Total' value.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${mismatches.length} 'Total' calculation error(s) found. See details below.`); 
                mismatches.forEach(item => { 
                    const diffCard = document.createElement('div'); 
                    diffCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    diffCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 mt-2"><p>Savings: <span class="font-medium">${item.savings.toLocaleString('en-IN')}</span></p><p>Excess: <span class="font-medium">${item.excess.toLocaleString('en-IN')}</span></p><p>Expected Total (S+E): <span class="font-bold text-green-700">${item.calculatedTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p><p>Actual Total in Sheet: <span class="font-bold text-red-700">${item.sheetTotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p></div>`; 
                    resultsContainer.appendChild(diffCard); 
                }); 
            } 
        }
        function runSavingsExcessCheck() { 
            updateErrorReport([], errorTypes.SAVINGS_EXCESS_LOGIC, ()=>{});
            runGenericValidation({ 
                keys: [{ keyName: 'amtWoKey', potentialNames: ['As per WO (Amt)'] }, { keyName: 'amtCwiKey', potentialNames: ['As per CWI (Amt)'] }, { keyName: 'savingsKey', potentialNames: ['Savings', 'Saving'] }, { keyName: 'excessKey', potentialNames: ['Excess'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: displaySavingsExcessCheckResults }, 
                (row, keys) => { 
                    const amtWO = parseFloat(row[keys.amtWoKey]) || 0; const amtCWI = parseFloat(row[keys.amtCwiKey]) || 0; const actualSavings = parseFloat(row[keys.savingsKey]) || 0; const actualExcess = parseFloat(row[keys.excessKey]) || 0; let expectedSavings = 0; let expectedExcess = 0; const difference = amtCWI - amtWO; 
                    if (amtWO > amtCWI) { expectedSavings = difference; } 
                    if (amtCWI > amtWO) { expectedExcess = difference; } 
                    if (Math.abs(actualSavings - expectedSavings) > 0.01 || Math.abs(actualExcess - expectedExcess) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', amtWO, amtCWI, actualSavings, actualExcess, expectedSavings, expectedExcess }; } return null; 
                }); 
        }
        function displaySavingsExcessCheckResults(mismatches) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const savingsExcessFormatter = (mismatch, type) => ({
                particulars: `${mismatch.uCode} - ${mismatch.particulars}`,
                type: type,
                correction: `Logic error. Based on WO Amt (${mismatch.amtWO.toLocaleString()}) and CWI Amt (${mismatch.amtCWI.toLocaleString()}), the expected Savings/Excess should be ${mismatch.expectedSavings.toLocaleString()}/${mismatch.expectedExcess.toLocaleString()}, but the sheet shows ${mismatch.actualSavings.toLocaleString()}/${mismatch.actualExcess.toLocaleString()}.`
            });
            updateErrorReport(mismatches, errorTypes.SAVINGS_EXCESS_LOGIC, savingsExcessFormatter);

            if (mismatches.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Logic Validated!</div><div class="text-green-700 mt-1">All 'Savings' and 'Excess' values are calculated correctly.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! The logic for 'Savings' and 'Excess' holds true for all items."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Calculation Logic Errors</div><div class="text-red-700 mt-1">${mismatches.length} item(s) have incorrect 'Savings' or 'Excess' values.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${mismatches.length} calculation logic error(s) found. See details below.`); 
                mismatches.forEach(item => { 
                    const diffCard = document.createElement('div'); 
                    diffCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    diffCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-xs text-gray-600 mt-1">(WO Amt: ${item.amtWO.toLocaleString('en-IN')}, CWI Amt: ${item.amtCWI.toLocaleString('en-IN')})</div><div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 mt-2"><p>Actual Savings: <span class="font-bold ${Math.abs(item.actualSavings - item.expectedSavings) > 0.01 ? 'text-red-700' : ''}">${item.actualSavings.toLocaleString('en-IN')}</span></p><p>Expected Savings: <span class="font-bold text-green-700">${item.expectedSavings.toLocaleString('en-IN')}</span></p><p>Actual Excess: <span class="font-bold ${Math.abs(item.actualExcess - item.expectedExcess) > 0.01 ? 'text-red-700' : ''}">${item.actualExcess.toLocaleString('en-IN')}</span></p><p>Expected Excess: <span class="font-bold text-green-700">${item.expectedExcess.toLocaleString('en-IN')}</span></p></div>`; 
                    resultsContainer.appendChild(diffCard); 
                }); 
            } 
        }
        function runFalseCheckValidation() { 
            updateErrorReport([], errorTypes.FALSE_CHECK, ()=>{});
            runGenericValidation({ 
                keys: [{ keyName: 'trueFalseKey', potentialNames: ['True/False', 'True False'] }, { keyName: 'checkKey', potentialNames: ['Check'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: displayFalseCheckResults }, 
                (row, keys) => { 
                    const trueFalseValue = row[keys.trueFalseKey]; 
                    if (trueFalseValue === false || String(trueFalseValue).trim().toLowerCase() === 'false') { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', checkValue: row[keys.checkKey] !== undefined ? row[keys.checkKey] : 'N/A' }; } return null; 
                }); 
        }
        function displayFalseCheckResults(mismatches) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const falseCheckFormatter = (mismatch, type) => ({
                particulars: `${mismatch.uCode} - ${mismatch.particulars}`,
                type: type,
                correction: `The 'True/False' column for this item is FALSE, indicating a mismatch. The value in the 'Check' column is ${mismatch.checkValue}. Review underlying calculations.`
            });
            updateErrorReport(mismatches, errorTypes.FALSE_CHECK, falseCheckFormatter);

            if (mismatches.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All Checks Passed!</div><div class="text-green-700 mt-1">No rows were found with a 'FALSE' value.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! All checks have passed. No 'FALSE' values found."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Mismatched Totals Found</div><div class="text-red-700 mt-1">${mismatches.length} item(s) failed the 'True/False' check.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${mismatches.length} item(s) failed the 'True/False' check. See details below.`); 
                mismatches.forEach(item => { 
                    const diffCard = document.createElement('div'); 
                    diffCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    const checkValueFormatted = typeof item.checkValue === 'number' ? `₹${item.checkValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : item.checkValue; 
                    diffCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-sm grid grid-cols-2 gap-4 mt-2"><p>Status: <span class="font-bold text-red-700">FALSE</span></p><p>'Check' Value: <span class="font-medium">${checkValueFormatted}</span></p></div>`; 
                    resultsContainer.appendChild(diffCard); 
                }); 
            } 
        }
        function displayVarianceCheckResults(mismatches, config) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden');
            const labels = config.labels;
            const errorType = config.errorType;

            const varianceFormatter = (mismatch, type) => ({
                particulars: `${mismatch.uCode} - ${mismatch.particulars}`,
                type: type,
                correction: `Calculation for '${labels.title}' is incorrect. Expected variance is ${mismatch.calculatedVariance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}, but the sheet shows ${mismatch.sheetVariance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}.`
            });
            updateErrorReport(mismatches, errorType, varianceFormatter);

            if (mismatches.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${labels.title} Validated!</div><div class="text-green-700 mt-1">${labels.success}</div>`; 
                resultsContainer.appendChild(successCard); 
                alert(`Perfect! ${labels.success}`); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>${labels.title} Mismatches</div><div class="text-red-700 mt-1">${mismatches.length} item(s) have ${labels.error}</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${mismatches.length} variance calculation error(s) found. See details below.`); 
                mismatches.forEach(item => { 
                    const diffCard = document.createElement('div'); 
                    diffCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    diffCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-xs text-gray-600 mt-1">(${labels.col1}: ${item.val1.toLocaleString('en-IN')}, ${labels.col2}: ${item.val2.toLocaleString('en-IN')})</div><div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 mt-2"><p>Expected Variance: <span class="font-bold text-green-700">${item.calculatedVariance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p><p>Actual Variance: <span class="font-bold text-red-700">${item.sheetVariance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p></div>`; 
                    resultsContainer.appendChild(diffCard); 
                }); 
            } 
        }
        function runPostAuditWoCheck() {
            updateErrorReport([], errorTypes.POST_AUDIT_WO_VARIANCE, ()=>{});
            runGenericValidation({ 
                errorType: errorTypes.POST_AUDIT_WO_VARIANCE,
                keys: [{ keyName: 'varianceKey', potentialNames: ['Variance Post Audit VS WO (Qty)'] }, { keyName: 'val1Key', potentialNames: ['As per Post Audit (Qty)'] }, { keyName: 'val2Key', potentialNames: ['As per WO - Qty'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: (m, c) => displayVarianceCheckResults(m, c), 
                labels: { title: "Post-Audit vs WO Quantity Variance", success: "All 'Variance Post Audit VS WO (Qty)' values are correct.", error: "incorrect 'Variance Post Audit VS WO (Qty)' values.", col1: 'Post-Audit Qty', col2: 'WO Qty'} }, 
                (row, keys) => { 
                    const sheetVariance = parseFloat(row[keys.varianceKey]) || 0; const val1 = parseFloat(row[keys.val1Key]) || 0; const val2 = parseFloat(row[keys.val2Key]) || 0; const calculatedVariance = val1 - val2; 
                    if (Math.abs(sheetVariance - calculatedVariance) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', val1: val1, val2: val2, sheetVariance, calculatedVariance }; } return null; 
                }); 
        }
        function runPreAuditCwiCheck() { 
            updateErrorReport([], errorTypes.PRE_AUDIT_CWI_VARIANCE, ()=>{});
            runGenericValidation({ 
                errorType: errorTypes.PRE_AUDIT_CWI_VARIANCE,
                keys: [{ keyName: 'varianceKey', potentialNames: ['Variance Pre Audit VS CWI (Qty)'] }, { keyName: 'val1Key', potentialNames: ['As per CWI (Qty)'] }, { keyName: 'val2Key', potentialNames: ['As per Pre Audit (Qty)'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: (m,c) => displayVarianceCheckResults(m, c), 
                labels: { title: "Pre-Audit vs CWI Quantity Variance", success: "All 'Variance Pre Audit VS CWI (Qty)' values are correct.", error: "incorrect 'Variance Pre Audit VS CWI (Qty)' values.", col1: 'CWI Qty', col2: 'Pre-Audit Qty' } }, 
                (row, keys) => { 
                    const sheetVariance = parseFloat(row[keys.varianceKey]) || 0; const val1 = parseFloat(row[keys.val1Key]) || 0; const val2 = parseFloat(row[keys.val2Key]) || 0; const calculatedVariance = val1 - val2; 
                    if (Math.abs(sheetVariance - calculatedVariance) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', val1: val1, val2: val2, sheetVariance, calculatedVariance }; } return null; 
                }); 
        }
        // --- NEW ---
        function runPostAuditWoAmtCheck() {
            updateErrorReport([], errorTypes.POST_AUDIT_WO_VARIANCE_AMT, ()=>{});
            runGenericValidation({ 
                errorType: errorTypes.POST_AUDIT_WO_VARIANCE_AMT,
                keys: [{ keyName: 'varianceKey', potentialNames: ['Variance Post Audit VS WO (Amt)'] }, { keyName: 'val1Key', potentialNames: ['As per Post Audit (Amt)'] }, { keyName: 'val2Key', potentialNames: ['As per WO (Amt)'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: (m, c) => displayVarianceCheckResults(m, c), 
                labels: { title: "Post-Audit vs WO Amount Variance", success: "All 'Variance Post Audit VS WO (Amt)' values are correct.", error: "incorrect 'Variance Post Audit VS WO (Amt)' values.", col1: 'Post-Audit Amt', col2: 'WO Amt'} }, 
                (row, keys) => { 
                    const sheetVariance = parseFloat(row[keys.varianceKey]) || 0; const val1 = parseFloat(row[keys.val1Key]) || 0; const val2 = parseFloat(row[keys.val2Key]) || 0; const calculatedVariance = val1 - val2; 
                    if (Math.abs(sheetVariance - calculatedVariance) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', val1: val1, val2: val2, sheetVariance, calculatedVariance }; } return null; 
                }); 
        }
        // --- NEW ---
        function runPreAuditCwiAmtCheck() { 
            updateErrorReport([], errorTypes.PRE_AUDIT_CWI_VARIANCE_AMT, ()=>{});
            runGenericValidation({ 
                errorType: errorTypes.PRE_AUDIT_CWI_VARIANCE_AMT,
                keys: [{ keyName: 'varianceKey', potentialNames: ['Variance Pre Audit VS CWI (Amt)'] }, { keyName: 'val1Key', potentialNames: ['As per CWI (Amt)'] }, { keyName: 'val2Key', potentialNames: ['As per Pre Audit (Amt)'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: (m,c) => displayVarianceCheckResults(m, c), 
                labels: { title: "Pre-Audit vs CWI Amount Variance", success: "All 'Variance Pre Audit VS CWI (Amt)' values are correct.", error: "incorrect 'Variance Pre Audit VS CWI (Amt)' values.", col1: 'CWI Amt', col2: 'Pre-Audit Amt' } }, 
                (row, keys) => { 
                    const sheetVariance = parseFloat(row[keys.varianceKey]) || 0; const val1 = parseFloat(row[keys.val1Key]) || 0; const val2 = parseFloat(row[keys.val2Key]) || 0; const calculatedVariance = val1 - val2; 
                    if (Math.abs(sheetVariance - calculatedVariance) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', val1: val1, val2: val2, sheetVariance, calculatedVariance }; } return null; 
                }); 
        }

        function runVarianceCwiWoCheck() { 
            updateErrorReport([], errorTypes.CWI_WO_VARIANCE, ()=>{});
            runGenericValidation({ 
                errorType: errorTypes.CWI_WO_VARIANCE,
                keys: [ { keyName: 'varianceKey', potentialNames: ['Variance (CWI vs WO)'] }, { keyName: 'val1Key', potentialNames: ['As per CWI (Qty)'] }, { keyName: 'val2Key', potentialNames: ['As per WO - Qty'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: (m, c) => displayVarianceCheckResults(m, c), 
                labels: { title: "CWI vs WO Quantity Variance", success: "All 'Variance (CWI vs WO)' values are correct.", error: "incorrect 'Variance (CWI vs WO)' values.", col1: 'CWI Qty', col2: 'WO Qty' } }, 
                (row, keys) => { 
                    const sheetVariance = parseFloat(row[keys.varianceKey]) || 0; const val1 = parseFloat(row[keys.val1Key]) || 0; const val2 = parseFloat(row[keys.val2Key]) || 0; const calculatedVariance = val1 - val2; 
                    if (Math.abs(sheetVariance - calculatedVariance) > 0.01) { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', val1: val1, val2: val2, sheetVariance, calculatedVariance }; } return null; 
                }); 
        }
        function runWorkNotInWoCheck() {
            updateErrorReport([], errorTypes.WORK_NOT_IN_WO, ()=>{});
            runGenericValidation({ 
                keys: [{ keyName: 'varianceKey', potentialNames: ['Variance Post Audit VS WO (Qty)'] }, { keyName: 'woQtyKey', potentialNames: ['As per WO - Qty', 'As per WO/PO (Qty)'] }, { keyName: 'remarkKey', potentialNames: ['Remark', 'Remarks'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }, ], 
                displayResults: displayWorkNotInWoResults }, 
                (row, keys) => { 
                    const variance = parseFloat(row[keys.varianceKey]) || 0; const woQty = parseFloat(row[keys.woQtyKey]) || 0; const remark = (row[keys.remarkKey] || '').toString().trim(); 
                    if (variance > 0 && woQty === 0 && remark === '') { return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', variance: variance, }; } return null; 
                }); 
        }
        function displayWorkNotInWoResults(issues) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const workNotInWoFormatter = (issue, type) => ({
                particulars: `${issue.uCode} - ${issue.particulars}`,
                type: type,
                correction: `This item has an executed quantity (${issue.variance.toLocaleString()}) but was not in the original Work Order (WO Qty = 0). A remark is required for approval.`
            });
            updateErrorReport(issues, errorTypes.WORK_NOT_IN_WO, workNotInWoFormatter);

            if (issues.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All Checks Passed!</div><div class="text-green-700 mt-1">No items found that were executed without being in the Work Order and are missing a remark.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! No items were found that required a remark."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 border-red-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-red-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Action Required: Missing Remarks</div><div class="text-red-700 mt-1">${issues.length} item(s) were executed but not in the Work Order and require a remark for approval.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${issues.length} item(s) require a remark. See details below.`); 
                issues.forEach(item => { 
                    const issueCard = document.createElement('div'); 
                    issueCard.className = 'p-4 rounded-lg border border-red-300 bg-red-50'; 
                    issueCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="text-sm grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 mt-2"><p>Status: <span class="font-bold text-red-700">Remark Required</span></p><p>Variance Qty: <span class="font-medium">${item.variance.toLocaleString('en-IN')}</span></p></div><div class="text-xs text-gray-600 mt-2">This item has an executed quantity but was not in the original Work Order (WO Qty = 0). Please add a remark like 'Work executed but not in WO. PM approval required.'</div>`; 
                    resultsContainer.appendChild(issueCard); 
                }); 
            } 
        }
        function runExceededWoQtyCheck() { 
            updateErrorReport([], errorTypes.EXCEEDED_WO_QTY, ()=>{});
            runGenericValidation({ 
                keys: [ { keyName: 'varianceKey', potentialNames: ['Variance Post Audit VS WO (Qty)', 'Variation in quantity: WO vs. Contractor (Post-Audit)'] }, { keyName: 'woQtyKey', potentialNames: ['As per WO - Qty', 'As per WO/PO (Qty)'] }, { keyName: 'postAuditQtyKey', potentialNames: ['As per Post Audit (Qty)'] }, { keyName: 'remarkKey', potentialNames: ['Remark', 'Remarks'] }, { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] }, { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] } ], 
                displayResults: displayExceededWoQtyResults }, 
                (row, keys) => { 
                    const variance = parseFloat(row[keys.varianceKey]) || 0; const woQty = parseFloat(row[keys.woQtyKey]) || 0; const remark = (row[keys.remarkKey] || '').toString().trim(); 
                    if (variance > 0 && woQty > 0 && remark === '') { const postAuditQty = parseFloat(row[keys.postAuditQtyKey]) || 0; return { uCode: row[keys.uCodeKey] || 'N/A', particulars: row[keys.particularsKey] || 'No Description', woQty, postAuditQty, variance }; } return null; 
                }); 
        }
        function displayExceededWoQtyResults(issues) { 
            resultsContainer.innerHTML = ''; validationResultsEl.classList.remove('hidden'); 
            const exceededWoQtyFormatter = (issue, type) => ({
                particulars: `${issue.uCode} - ${issue.particulars}`,
                type: type,
                correction: `Executed quantity (${issue.postAuditQty.toLocaleString()}) exceeds WO quantity (${issue.woQty.toLocaleString()}) by ${issue.variance.toLocaleString()}. A remark explaining the excess is required.`
            });
            updateErrorReport(issues, errorTypes.EXCEEDED_WO_QTY, exceededWoQtyFormatter);

            if (issues.length === 0) { 
                const successCard = document.createElement('div'); successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center'; 
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>No Unexplained Exceeded Quantities</div><div class="text-green-700 mt-1">All items with quantities exceeding the Work Order have been remarked.</div>`; 
                resultsContainer.appendChild(successCard); 
                alert("Perfect! No unexplained exceeded quantities were found."); 
            } else { 
                const errorSummaryCard = document.createElement('div'); 
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-yellow-100 border-yellow-300'; 
                errorSummaryCard.innerHTML = `<div class="font-bold text-yellow-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Exceeded Quantities Require Remarks</div><div class="text-yellow-700 mt-1">${issues.length} item(s) were executed in excess and are missing a remark.</div>`; 
                resultsContainer.appendChild(errorSummaryCard); 
                alert(`${issues.length} item(s) exceeded the WO quantity and require a remark. See details below.`); 
                issues.forEach(item => { 
                    const issueCard = document.createElement('div'); 
                    issueCard.className = 'p-4 rounded-lg border border-yellow-400 bg-yellow-50'; 
                    issueCard.innerHTML = `<p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p><div class="mt-2 p-2 bg-yellow-100 rounded-md"><div class="text-sm grid grid-cols-1 md:grid-cols-3 gap-2"><p>WO Qty: <span class="font-medium">${item.woQty.toLocaleString('en-IN')}</span></p><p>Executed Qty: <span class="font-bold text-red-700">${item.postAuditQty.toLocaleString('en-IN')}</span></p><p>Exceeded By: <span class="font-medium">${item.variance.toLocaleString('en-IN')}</span></p></div></div><div class="text-sm mt-2"><p>Status: <span class="font-bold text-red-700">Remark Required</span></p></div>`; 
                    resultsContainer.appendChild(issueCard); 
                }); 
            } 
        }
        
        function runVarianceThresholdCheck() {
            updateErrorReport([], errorTypes.POSITIVE_VARIANCE_NOS, ()=>{});
            runGenericValidation({
                keys: [
                    { keyName: 'unitKey', potentialNames: ['Unit'] },
                    { keyName: 'postAuditQtyKey', potentialNames: ['As per Post Audit (Qty)'] },
                    { keyName: 'woQtyKey', potentialNames: ['As per WO - Qty', 'As per WO/PO (Qty)'] },
                    { keyName: 'uCodeKey', potentialNames: ['U.code', 'U Code'] },
                    { keyName: 'particularsKey', potentialNames: ['Particulars', 'Item'] }
                ],
                displayResults: displayVarianceThresholdResults
            }, (row, keys) => {
                const unit = (row[keys.unitKey] || '').toString().toLowerCase().replace(/\./g, '');
                const targetUnits = ['nos', 'no'];
                
                if (!targetUnits.includes(unit)) {
                    return null;
                }

                const postAuditQty = parseFloat(row[keys.postAuditQtyKey]) || 0;
                const woQty = parseFloat(row[keys.woQtyKey]) || 0;
                
                if (woQty === 0) {
                    return null;
                }

                const variancePct = ((postAuditQty - woQty) / woQty) * 100;

                if (variancePct > 10) {
                    return {
                        uCode: row[keys.uCodeKey] || 'N/A',
                        particulars: row[keys.particularsKey] || 'No Description',
                        woQty,
                        postAuditQty,
                        variancePct
                    };
                }
                
                return null;
            });
        }
        
        function displayVarianceThresholdResults(issues) {
            resultsContainer.innerHTML = '';
            validationResultsEl.classList.remove('hidden');

            const varianceNosFormatter = (issue, type) => ({
                particulars: `${issue.uCode} - ${issue.particulars}`,
                type: type,
                correction: `Quantity variance for this 'Nos.' item is +${issue.variancePct.toFixed(2)}%, which is over the 10% threshold. (WO Qty: ${issue.woQty.toLocaleString()}, Executed Qty: ${issue.postAuditQty.toLocaleString()}). Please review for accuracy.`
            });
            updateErrorReport(issues, errorTypes.POSITIVE_VARIANCE_NOS, varianceNosFormatter);

            if (issues.length === 0) {
                const successCard = document.createElement('div');
                successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center';
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>All Variances OK</div><div class="text-green-700 mt-1">No 'Nos.' items found with a positive quantity variance exceeding 10%.</div>`;
                resultsContainer.appendChild(successCard);
                alert("Perfect! All 'Nos.' item quantity variances are within the threshold.");
            } else {
                const errorSummaryCard = document.createElement('div');
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-orange-100 border-orange-300';
                errorSummaryCard.innerHTML = `<div class="font-bold text-orange-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Significant Variances Found</div><div class="text-orange-700 mt-1">${issues.length} 'Nos.' item(s) have a positive quantity variance greater than 10%.</div>`;
                resultsContainer.appendChild(errorSummaryCard);
                alert(`${issues.length} 'Nos.' item(s) exceeded the >10% positive variance threshold. See details below.`);
                
                issues.forEach(item => {
                    const issueCard = document.createElement('div');
                    const varianceText = `<span class="font-bold text-orange-800">+${item.variancePct.toFixed(2)}%</span>`;
                    const cardClass = 'p-4 rounded-lg border border-orange-400 bg-orange-50';
                    
                    issueCard.className = cardClass;
                    issueCard.innerHTML = `
                        <p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p>
                        <div class="mt-2 p-2 bg-white/50 rounded-md">
                            <div class="text-sm grid grid-cols-1 md:grid-cols-3 gap-2">
                                <p>Planned Qty (WO): <span class="font-medium">${item.woQty.toLocaleString('en-IN')}</span></p>
                                <p>Actual Qty (Post-Audit): <span class="font-medium">${item.postAuditQty.toLocaleString('en-IN')}</span></p>
                                <p>Variance: ${varianceText}</p>
                            </div>
                        </div>`;
                    resultsContainer.appendChild(issueCard);
                });
            }
        }

        function runRunningItemsVarianceCheck() {
            updateErrorReport([], errorTypes.POSITIVE_VARIANCE_RUNNING, ()=>{});
            runGenericValidation({
                keys: [
                    { keyName: 'unitKey', potentialNames: ['Unit'] },
                    { keyName: 'postAuditQtyKey', potentialNames: ['As per Post Audit (Qty)'] },
                    { keyName: 'woQtyKey', potentialNames: ['As per WO - Qty', 'As per WO/PO (Qty)'] },
                    { keyName: 'uCodeKey', potentialNames: ['U Code'] },
                    { keyName: 'particularsKey', potentialNames: ['Particulars'] }
                ],
                displayResults: displayRunningItemsVarianceResults
            }, (row, keys) => {
                const unit = (row[keys.unitKey] || '').toString().toLowerCase().replace(/\./g, '');
                const isRunningUnit = unit.includes('rft') || unit.includes('rmt');
                
                if (!isRunningUnit) {
                    return null; 
                }

                const postAuditQty = parseFloat(row[keys.postAuditQtyKey]) || 0;
                const woQty = parseFloat(row[keys.woQtyKey]) || 0;

                if (woQty === 0) {
                    return null;
                }

                const variancePct = ((postAuditQty - woQty) / woQty) * 100;

                if (variancePct > 10) {
                    return {
                        uCode: row[keys.uCodeKey] || 'N/A',
                        particulars: row[keys.particularsKey] || 'No Description',
                        unit: row[keys.unitKey],
                        woQty,
                        postAuditQty,
                        variancePct
                    };
                }
                
                return null;
            });
        }

        function displayRunningItemsVarianceResults(issues) {
            resultsContainer.innerHTML = '';
            validationResultsEl.classList.remove('hidden');

            const varianceRunningFormatter = (issue, type) => ({
                particulars: `${issue.uCode} - ${issue.particulars}`,
                type: type,
                correction: `Quantity variance for this running item (${issue.unit}) is +${issue.variancePct.toFixed(2)}%, which is over the 10% threshold. (WO Qty: ${issue.woQty.toLocaleString()}, Executed Qty: ${issue.postAuditQty.toLocaleString()}). Please review for accuracy.`
            });
            updateErrorReport(issues, errorTypes.POSITIVE_VARIANCE_RUNNING, varianceRunningFormatter);

            if (issues.length === 0) {
                const successCard = document.createElement('div');
                successCard.className = 'p-4 rounded-lg border bg-green-100 border-green-300 text-center';
                successCard.innerHTML = `<div class="font-bold text-green-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Running Item Variances OK</div><div class="text-green-700 mt-1">No R.ft/R.mt items found with a positive quantity variance exceeding 10%.</div>`;
                resultsContainer.appendChild(successCard);
                alert("Perfect! All running item quantity variances are within the >10% threshold.");
            } else {
                const errorSummaryCard = document.createElement('div');
                errorSummaryCard.className = 'mb-4 p-4 rounded-lg text-center bg-cyan-100 border-cyan-300';
                errorSummaryCard.innerHTML = `<div class="font-bold text-cyan-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Significant Running Item Variances Found</div><div class="text-cyan-700 mt-1">${issues.length} R.ft/R.mt item(s) have a positive quantity variance greater than 10%.</div>`;
                resultsContainer.appendChild(errorSummaryCard);
                alert(`${issues.length} R.ft/R.mt item(s) exceeded the >10% positive variance threshold. See details below.`);
                
                issues.forEach(item => {
                    const issueCard = document.createElement('div');
                    const varianceText = `<span class="font-bold text-cyan-800">+${item.variancePct.toFixed(2)}%</span>`;
                    const cardClass = 'p-4 rounded-lg border border-cyan-400 bg-cyan-50';

                    issueCard.className = cardClass;
                    issueCard.innerHTML = `
                        <p class="font-semibold text-gray-800">${item.uCode} - ${item.particulars}</p>
                        <div class="mt-2 p-2 bg-white/50 rounded-md">
                            <div class="text-sm grid grid-cols-1 md:grid-cols-3 gap-2">
                                <p>Planned Qty (WO): <span class="font-medium">${item.woQty.toLocaleString('en-IN')}</span></p>
                                <p>Actual Qty (Post-Audit): <span class="font-medium">${item.postAuditQty.toLocaleString('en-IN')}</span></p>
                                <p>Variance (<span class="italic">${item.unit}</span>): ${varianceText}</p>
                            </div>
                        </div>`;
                    resultsContainer.appendChild(issueCard);
                });
            }
        }


        // --- DEBUG FUNCTION ---
        function debugHeaders() {
            validationResultsEl.classList.add('hidden');
            const extractedSheet = findSheet('Extracted Data');
            if (!extractedSheet) {
                alert("Could not find the 'Extracted Data' sheet.");
                return;
            }
            const sheetDataAsArray = XLSX.utils.sheet_to_json(extractedSheet, { header: 1, defval: '' });
            if (sheetDataAsArray.length < 1) {
                alert("'Extracted Data' sheet is empty or has no header row.");
                return;
            }
            const headers = sheetDataAsArray[0];
            let debugInfo = headers.map(h => {
                const charCodes = h.split('').map(char => char.charCodeAt(0)).join(', ');
                return `'${h}' (Char Codes: [${charCodes}])`;
            }).join('\n');
            resultsContainer.innerHTML = ''; 
            const overallStatus = document.createElement('div');
            overallStatus.className = 'mb-4 p-4 rounded-lg text-center bg-blue-100 border border-blue-300';
            overallStatus.innerHTML = `<div class="font-bold text-blue-800 text-lg flex items-center justify-center"><svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>Header Debug Information</div>`;
            resultsContainer.prepend(overallStatus);
            const debugCard = document.createElement('div');
            debugCard.className = 'p-4 rounded-lg border border-gray-300 bg-gray-50';
            debugCard.innerHTML = `<p class="font-semibold text-gray-800 mb-2">The following headers were read directly from the <b>first row</b> of your sheet. Compare them carefully with what you see in Excel. This will reveal any extra spaces or hidden special characters.</p><pre class="bg-white p-3 rounded text-sm whitespace-pre-wrap"><code>${debugInfo}</code></pre>`;
            resultsContainer.appendChild(debugCard);
            validationResultsEl.classList.remove('hidden');
            alert("Header debug information has been displayed in the results panel.");
        }
    </script>
</body>
</html>